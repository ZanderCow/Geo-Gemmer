{% macro gem_search_window() %}
<script>
    let paginationOffset = 0;
</script>
<div class="col-1 col-md-12 col-xl-7 col-xxl-7 flex-grow-1 flex-fill scstyle-1 sc-overflow">
    <div class="row scstyle-1 sc-overflow" style="overflow: scroll;">
        <div class="col">
            <div class="row">
                <div class="col-md-12">
                    <div class="d-xl-flex d-xxl-flex justify-content-xl-center align-items-xl-center justify-content-xxl-center align-items-xxl-center text-center" style="padding-top: 15px;">
                        <div id="type-dropdown" class="dropdown" style="padding-left: 15px;padding-right: 15px;">
                            <button class="btn dropdown-toggle" aria-expanded="false" data-bs-toggle="dropdown" type="button" style="padding: 0px;color: rgb(0,0,0);">
                                <span id="selected-type" style="color: rgb(0, 0, 0);">Type</span>
                            </button>
                            <div class="dropdown-menu">
                                <a class="dropdown-item" href="#" data-value="Hiking Trail">Hiking Trail</a>
                                <a class="dropdown-item" href="#" data-value="Restaurant">Restaurant</a>
                                <a class="dropdown-item" href="#" data-value="Park">Park</a>
                                <a class="dropdown-item" href="#" data-value="Gym">Gym</a>
                                <a class="dropdown-item" href="#" data-value="Museum">Museum</a>
                                <a class="dropdown-item" href="#" data-value="Beach">Beach</a>
                                <a class="dropdown-item" href="#" data-value="Shopping Mall">Shopping Mall</a>
                                <a class="dropdown-item" href="#" data-value="Movie Theater">Movie Theater</a>
                                <a class="dropdown-item" href="#" data-value="Zoo">Zoo</a>
                                <a class="dropdown-item" href="#" data-value="Aquarium">Aquarium</a>
                            </div>
                        </div>
                
                        <!-- Unique ID for each dropdown, using 'AccessibilityMenu1' as an example -->
                        <div id="accessibility-dropdown" class="dropdown" style="padding: 15px;">
                            <button class="btn dropdown-toggle" aria-expanded="false" data-bs-toggle="dropdown" type="button" style="padding: 0px; color: black;">
                                <span id="selected-accesibility" style="color: black;">Accessibility</span>
                            </button>
                            <div class="dropdown-menu">
                                <label class="dropdown-item"><input type="checkbox" name="accessibility" value="wheelchair_accessible"> Wheelchair Accessible</label>
                                <label class="dropdown-item"><input type="checkbox" name="accessibility" value="service_animal_friendly"> Service Animal Friendly</label>
                                <label class="dropdown-item"><input type="checkbox" name="accessibility" value="multilingual_support"> Multilingual Support</label>
                                <label class="dropdown-item"><input type="checkbox" name="accessibility" value="braille_signage"> Braille Signage</label>
                                <label class="dropdown-item"><input type="checkbox" name="accessibility" value="hearing_assistance"> Hearing Assistance</label>
                                <label class="dropdown-item"><input type="checkbox" name="accessibility" value="large_print_materials"> Large Print Materials</label>
                                <label class="dropdown-item"><input type="checkbox" name="accessibility" value="accessible_restrooms"> Accessible Restrooms</label>
                            </div>
                        </div>
                
                        <div id="distance-dropdown" class="dropdown" style="padding-left: 15px; padding-right: 15px;">
                            <button class="btn dropdown-toggle" aria-expanded="false" data-bs-toggle="dropdown" type="button" style="padding: 0px; color: rgb(0,0,0);">
                                <span id="selected-distance" style="color: rgb(0, 0, 0);">Distance</span>
                            </button>
                            <div class="dropdown-menu">
                                <label class="dropdown-item">
                                    <input id="distanceSlider" class="form-range" type="range" min="0" max="500" value="50" oninput="updateDistanceValue(this.value)"> <!-- Added min, max, and value attributes for demonstration -->
                                </label>
                                <label class="dropdown-item">
                                    <span class="text-center justify-content-md-center" id="distanceValue">50 mi</span> 
                                </label>
                            </div>
                        </div>
                 
                        <div id="review-dropdown" class="dropdown" style="padding-left: 15px;padding-right: 15px;">
                            <button class="btn dropdown-toggle" aria-expanded="false" data-bs-toggle="dropdown" type="button" style="padding: 0px;color: rgb(0,0,0);">
                                <span id="selected-review-option" style="color: rgb(0, 0, 0);">Minimum Rating</span>
                            </button>
                            <div class="dropdown-menu">
                                <a class="dropdown-item" href="#" data-value="1">1 Star</a>
                                <a class="dropdown-item" href="#" data-value="2">2 Stars</a>
                                <a class="dropdown-item" href="#" data-value="3">3 Stars</a>
                                <a class="dropdown-item" href="#" data-value="4">4 Stars</a>
                                <a class="dropdown-item" href="#" data-value="5">5 Stars</a>
                            </div>
                        </div>
                
                        
                        <button id="sumbit-filters"class="btn btn-success btn-sm" data-bss-hover-animate="pulse" type="submit"><span style="color: rgb(255, 255, 255);">Apply Filters</span></button>
                    </div>
                </div>
            </div>
            <div class="row">
                <div id="gem-search-outer-container"class="col">
                 
                    
                 
                    <section id="gem-search-container" class="overflow-auto" style="height: 600px;">
                        <!-- inject data -->
                        <div id="loading-bottom-thing"class="card d-xxl-flex justify-content-xxl-center mb-5 h-100 w-100">
                            <div class="card-body d-flex flex-column justify-content-center align-items-center justify-content-sm-center justify-content-md-center justify-content-lg-center justify-content-xl-center justify-content-xxl-center w-100 h-100"><span class="spinner-grow" role="status" style="color: var(--bs-primary);"></span></div>
                        </div>
                    <!-- inject data -->
    
                    </section>
        

                </div>
            </div>
        </div>
    </div>
</div>
<script>
document.getElementById('sumbit-filters').addEventListener('click', function() {
    document.getElementById('gem-search-container').innerHTML =`
    <div id="loading-bottom-thing"class="card d-xxl-flex justify-content-xxl-center mb-5 h-100 w-100">
        <div class="card-body d-flex flex-column justify-content-center align-items-center justify-content-sm-center justify-content-md-center justify-content-lg-center justify-content-xl-center justify-content-xxl-center w-100 h-100"><span class="spinner-grow" role="status" style="color: var(--bs-primary);"></span></div>
    </div>
    `;
    search();
});

</script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const section = document.getElementById('gem-search-container');
        let timeout; // To hold the timeout ID for debouncing
    
        section.addEventListener('scroll', function() {
            // Clear the previous timeout if it exists
            clearTimeout(timeout);
    
            // Set a new timeout to check the scroll position after 500 milliseconds
            timeout = setTimeout(function() {
                // Check if the user has scrolled to the bottom
                if (section.scrollTop + section.clientHeight >= section.scrollHeight - 400) {
                    search();
                }
                
            }, 100); // Delay of 500 milliseconds
        });
    });
    </script>
    


<script>
    document.addEventListener("DOMContentLoaded", function() {
        search();
    });
</script>

<script>
    function createGemCard(gem){
        var card = document.createElement('div');
        card.className = 'card';
        card.innerHTML = `
        <div class="card-body px-4 py-5 px-md-5" style="padding: 0px;">
            <div class="row">
                <div class="col-md-4 col-lg-6 col-xl-5 col-xxl-6 offset-xl-0 offset-xxl-0 d-md-flex d-xl-flex d-xxl-flex justify-content-md-center align-items-md-center align-items-xl-center align-items-xxl-center">
                    <header id="greeting-2" class="bg-primary-gradient" style="background: #ffffff;">
                        <div class="text-center">
                            <p class="fw-bold text-success mb-2">Gem</p>
                            <h3 class="fw-bold" style="padding: 15px;">${gem.name}</h3>
                                <svg viewBox="0 0 16 16" height="16px"><path d="M3.612 15.443c-.386.198-.824-.149-.746-.592l.83-4.73L.173 6.765c-.329-.314-.158-.888.283-.95l4.898-.696L7.538.792c.197-.39.73-.39.927 0l2.184 4.327 4.898.696c.441.062.612.636.282.95l-3.522 3.356.83 4.73c.078.443-.36.79-.746.592L8 13.187l-4.389 2.256z"></path></svg>
                                <svg viewBox="-1 -1 19 19" height="16px"><path stroke="black" stroke-width="2" fill="white" d="M3.612 15.443c-.386.198-.824-.149-.746-.592l.83-4.73L.173 6.765c-.329-.314-.158-.888.283-.95l4.898-.696L7.538.792c.197-.39.73-.39.927 0l2.184 4.327 4.898.696c.441.062.612.636.282.95l-3.522 3.356.83 4.73c.078.443-.36.79-.746.592L8 13.187l-4.389 2.256z"></path></svg>
                        </div>
                    </header>
                </div>
                <div id="gem-image" class="col-md-8 col-lg-6 col-xl-7 col-xxl-6 offset-xl-0 offset-xxl-0 d-xxl-flex justify-content-xxl-end"><img class="rounded d-xl-flex align-items-xl-center fit-cover w-100" style="min-height: 300px;" src="PLACEHOLDER" width="659" height="373"></div>
            </div>
            <div class="row" style="padding-top: 20px;">
                <div class="col-md-4 offset-xxl-1 d-xxl-flex justify-content-xxl-center align-items-xxl-center">
                    <div class="card flex-grow-1 flex-fill">
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-6 col-xl-6 col-xxl-3 d-lg-flex d-xxl-flex justify-content-lg-center align-items-lg-center justify-content-xxl-center align-items-xxl-center"><svg xmlns="http://www.w3.org/2000/svg" width="1em" height="1em" viewBox="0 0 24 24" fill="none" class="text-success" style="top: 1rem;center: 1rem;font-size: 35px;">
                                        <path fill-rule="evenodd" clip-rule="evenodd" d="M11 17.9C8.71776 17.4367 7 15.419 7 13V7C7 4.23858 9.23858 2 12 2C14.7614 2 17 4.23858 17 7V13C17 15.419 15.2822 17.4367 13 17.9V21C13 21.5523 12.5523 22 12 22C11.4477 22 11 21.5523 11 21V17.9ZM12 4C13.6569 4 15 5.34315 15 7V13C15 14.3062 14.1652 15.4175 13 15.8293V11C13 10.4477 12.5523 10 12 10C11.4477 10 11 10.4477 11 11V15.8293C9.83481 15.4175 9 14.3062 9 13V7C9 5.34315 10.3431 4 12 4Z" fill="currentColor"></path>
                                    </svg></div>
                                <div class="col-md-12 col-xl-12 col-xxl-9">
                                    <h5 class="fw-bold text-center" style="padding-top: 10px;">Type</h5>
                                    <p class="text-center text-muted mb-4">${gem.gem_type}</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-4 offset-xxl-0 d-xxl-flex justify-content-xxl-center align-items-xxl-center">
                    <div class="card flex-grow-1 flex-fill">
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-6 col-xxl-3 d-lg-flex d-xxl-flex justify-content-sm-center align-items-sm-center justify-content-md-center align-items-md-center justify-content-lg-center align-items-lg-center justify-content-xl-center align-items-xl-center justify-content-xxl-center align-items-xxl-center"><svg xmlns="http://www.w3.org/2000/svg" width="1em" height="1em" viewBox="0 0 24 24" fill="none" class="text-success" style="top: 1rem;center: 1rem;font-size: 35px;">
                                        <path fill-rule="evenodd" clip-rule="evenodd" d="M12 21C16.9706 21 21 16.9706 21 12C21 7.02944 16.9706 3 12 3C7.02944 3 3 7.02944 3 12C3 16.9706 7.02944 21 12 21ZM14.8055 18.4151C17.1228 17.4003 18.7847 15.1667 18.9806 12.525C18.1577 12.9738 17.12 13.3418 15.9371 13.598C15.7882 15.4676 15.3827 17.1371 14.8055 18.4151ZM9.1945 5.58487C7.24725 6.43766 5.76275 8.15106 5.22208 10.244C5.4537 10.4638 5.84813 10.7341 6.44832 11.0008C6.89715 11.2003 7.42053 11.3798 8.00537 11.5297C8.05853 9.20582 8.50349 7.11489 9.1945 5.58487ZM10.1006 13.9108C10.2573 15.3675 10.5852 16.6202 10.9992 17.5517C11.2932 18.2133 11.5916 18.6248 11.8218 18.8439C11.9037 18.9219 11.9629 18.9634 12 18.9848C12.0371 18.9634 12.0963 18.9219 12.1782 18.8439C12.4084 18.6248 12.7068 18.2133 13.0008 17.5517C13.4148 16.6202 13.7427 15.3675 13.8994 13.9108C13.2871 13.9692 12.6516 14 12 14C11.3484 14 10.7129 13.9692 10.1006 13.9108ZM8.06286 13.598C8.21176 15.4676 8.61729 17.1371 9.1945 18.4151C6.8772 17.4003 5.21525 15.1666 5.01939 12.525C5.84231 12.9738 6.88001 13.3418 8.06286 13.598ZM13.9997 11.8896C13.369 11.9609 12.6993 12 12 12C11.3008 12 10.631 11.9609 10.0003 11.8896C10.0135 9.66408 10.4229 7.74504 10.9992 6.44832C11.2932 5.78673 11.5916 5.37516 11.8218 5.15605C11.9037 5.07812 11.9629 5.03659 12 5.01516C12.0371 5.03659 12.0963 5.07812 12.1782 5.15605C12.4084 5.37516 12.7068 5.78673 13.0008 6.44832C13.5771 7.74504 13.9865 9.66408 13.9997 11.8896ZM15.9946 11.5297C15.9415 9.20582 15.4965 7.11489 14.8055 5.58487C16.7528 6.43766 18.2373 8.15107 18.7779 10.244C18.5463 10.4638 18.1519 10.7341 17.5517 11.0008C17.1029 11.2003 16.5795 11.3798 15.9946 11.5297Z" fill="currentColor"></path>
                                    </svg></div>
                                <div class="col-md-12 col-xl-12 col-xxl-9">
                                    <h5 class="fw-bold text-center" style="padding-top: 10px;">Distance</h5>
                                    <p class="text-center text-muted mb-4">${gem.distance} mi away</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-4 col-xxl-3 offset-xxl-0 d-flex d-md-flex d-xl-flex d-xxl-flex justify-content-center align-items-md-center align-items-xl-center justify-content-xxl-center align-items-xxl-center">
                    <a class="btn btn-success btn-lg" role="button" href="/gem/${gem.gem_id}"><span style="color: rgb(255, 255, 255);">View Details</span></a>
            </div>
        </div>
        
        `;

        // Add hover event listeners to buttons for continuous animation
        card.querySelectorAll('button').forEach(button => {
            button.addEventListener('mouseover', () => {
                button.classList.add('animate__animated', 'animate__pulse', 'animate__infinite',"animate__fast");
                });
            button.addEventListener('mouseout', () => {
                button.classList.remove('animate__animated', 'animate__pulse', 'animate__infinite',"animate__fast");
                });
            });



        return card;
    }
</script>
<script>
    function createLoadingBottomThing(){
        var card = document.createElement('div');
        card.className = 'card d-xxl-flex justify-content-xxl-center mb-5 h-100 w-100';
        card.id = 'loading-bottom-thing';
        card.innerHTML = `
        <div id="loading-bottom-thing"class="card d-xxl-flex justify-content-xxl-center mb-5 h-100 w-100">
            <div class="card-body d-flex flex-column justify-content-center align-items-center justify-content-sm-center justify-content-md-center justify-content-lg-center justify-content-xl-center justify-content-xxl-center w-100 h-100"><span class="spinner-grow" role="status" style="color: var(--bs-primary);"></span></div>
        </div>
        `;
        
        return card;
        
    }

</script>

<script>
    function search(){
        const selectedType = document.getElementById('selected-type').textContent;
        const accessibilityOptions = Array.from(document.querySelectorAll('input[name="accessibility"]:checked')).map(el => el.value);
        const selectedDistance = document.getElementById('distanceValue').textContent;
        const selectedReview = document.getElementById('selected-review-option').textContent;
        const pagination_offset = paginationOffset;

        // Log the selected values
        console.log('Selected Type:', selectedType);
        console.log(selectedType === 'Type');
        console.log('Selected Distance:', selectedDistance);
        console.log(selectedDistance === "50 mi");
        console.log('Selected Minimum Rating:', selectedReview);
        console.log(selectedReview === 'Minimum Rating')
        console.log('Selected Accessibility Options:', accessibilityOptions.join(', '));
        console.log(accessibilityOptions.length === 0);



        if ("geolocation" in navigator) {
            navigator.geolocation.getCurrentPosition(function(position) {
                
                const urlParams = new URLSearchParams(window.location.search);
                const searchBarValue = urlParams.get('searchbar');

                const search = searchBarValue;
                const latitude = position.coords.latitude;
                const longitude = position.coords.longitude;
                const type = selectedType;
                const wheelchair_acessibile = accessibilityOptions.includes('wheelchair_accessible');
                const service_animal_friendly = accessibilityOptions.includes('service_animal_friendly');
                const multilingual_support = accessibilityOptions.includes('multilingual_support');
                const braille_signage = accessibilityOptions.includes('braille_signage');
                const hearing_assistance = accessibilityOptions.includes('hearing_assistance');
                const large_print_materials = accessibilityOptions.includes('large_print_materials');
                const accessible_restrooms = accessibilityOptions.includes('accessible_restrooms');
                const distance = selectedDistance.split(' ')[0];

                search_query = ``;
                if (selectedType === 'Type' && accessibilityOptions.length === 0 && selectedDistance === "50 mi" && selectedReview === 'Minimum Rating'){
                    search_query = `/gem/search/?searchbar=charlotte&new_page=false&offset=${pagination_offset}&latitude=${latitude}&longitude=${longitude}`;
                }
                else {
                    search_query = `/gem/search/?searchbar=${search}&new_page=false&offset=${pagination_offset}&latitude=${latitude}&longitude=${longitude}&type=${type}&wheelchair_accessible=${wheelchair_acessibile}&service_animal_friendly=${service_animal_friendly}&multilingual_support=${multilingual_support}&braille_signage=${braille_signage}&hearing_assistance=${hearing_assistance}&large_print_materials=${large_print_materials}&accessible_restrooms=${accessible_restrooms}&distance=${distance}&offset=false&new_page=false`;


                }
                
                const container = document.getElementById('gem-search-container');
                
                fetch(`${search_query}`, {
                    method: 'GET',
                    credentials: 'include'  // Necessary to include cookies with requests
                })
    
                .then((response) => {
                    if (response.ok) {
                        return response.json();
                    } 
                    else {
                        return response.text().then(text => {
                            throw new Error(text);
                        });
                    }
                })
    
                .then(data => { 
    
                    if (data.length === 0){
                        document.getElementById("gem-search-outer-container").innerHTML = `
                        <div id="gem-4" class="card">
                            <div class="card-body px-4 py-5 px-md-5">
                                <div class="text-uppercase text-primary fw-bold text-xs mb-1">
                                    <h5 class="text-capitalize fw-bold text-center d-xxl-flex justify-content-xxl-center" style="padding-bottom: 10px;"></h5>
                                </div>
                                <div class="row mb-5">
                                    <div class="col-md-12 col-lg-12 col-xl-12 col-xxl-12 text-center mx-auto">
                                        <h2 class="fw-bold">No Gems Found</h2>
                                        <p class="text-muted">Try searching up something else <br />or search with nothing and find <br />gems nearby!</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        `;
    
                    }
                    
                    else{
                        const container = document.getElementById('gem-search-container');

                        paginationOffset = paginationOffset + 20;
                        document.querySelector('#loading-bottom-thing').remove();
                        
    
                        data.forEach(item => {
                            const card = createGemCard(item);
                            
                            container.appendChild(card);
                            container.append
                        });
                        
                        const scroll_thing = createLoadingBottomThing()
                        container.appendChild(scroll_thing);
                        container.append
    
                    }
                
                })  
                .catch(error => {
                    console.error('Error:', error);
                });    
                  
                    
    
            }), function(error) {
                switch(error.code) {
                    case error.PERMISSION_DENIED:
                        alert("User denied the request for Geolocation.");
                        break;
                    case error.POSITION_UNAVAILABLE:
                        alert("Location information is unavailable.");
                        break;
                    case error.TIMEOUT:
                        alert("The request to get user location timed out.");
                        break;
                    default:
                        alert("An unknown error occurred.");
                        break;
                }
            };
        } 



        return;
    }
</script>

<script>
    document.addEventListener("DOMContentLoaded", function() {
        // Listen for changes or clicks within any dropdown menu
        document.querySelectorAll('.dropdown-menu').forEach(menu => {
            menu.addEventListener('click', function(e) {
                const target = e.target;
                if (target.tagName === 'A' || target.tagName === 'INPUT') {
                    updateDropdownText(target);
                }
            });
        });
    
        // Function to update the text of the dropdown button based on the selection
        function updateDropdownText(target) {
            const parentDropdown = target.closest('.dropdown');
            const dropdownId = parentDropdown.id;
            const dropdownButtonSpan = parentDropdown.querySelector('.btn.dropdown-toggle span');
    
            if (dropdownId === 'accessibility-dropdown' && target.type === 'checkbox') {
                // Handle checkbox selections for accessibility options
                updateAccessibilityText(parentDropdown, dropdownButtonSpan);
            } else if (target.type === 'range') {
                // Handle slider for distance
                dropdownButtonSpan.textContent = target.value + 'mi';
            } else if (target.tagName === 'A') {
                // Handle selections from dropdown links
                dropdownButtonSpan.textContent = target.textContent.trim();
            }
        }
    
        // Function to compile and display selected accessibility options
        function updateAccessibilityText(dropdown, button) {
            let selectedOptions = [];
            dropdown.querySelectorAll('input[type="checkbox"]:checked').forEach(checkbox => {
                selectedOptions.push(checkbox.parentNode.textContent.trim());
            });
            button.textContent = selectedOptions.join(', ');
        }
    
        // Function to update the display of the distance as the slider is moved
        const distanceSlider = document.getElementById('distanceSlider');
        if (distanceSlider) {
            distanceSlider.oninput = function() {
                document.getElementById('distanceValue').textContent = this.value + 'mi';
            };
        }
    });
</script>




{% endmacro %}

